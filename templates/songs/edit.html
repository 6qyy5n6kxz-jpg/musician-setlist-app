{% extends "base.html" %}

{% block content %}
<div class="section">
  <h2>Edit Song: {{ song.title }}</h2>

  <form method="post" action="{{ url_for('update_song', song_id=song.id) }}">
    <div class="form-group">
      <label for="title">Title *</label>
      <input type="text" id="title" name="title" value="{{ song.title }}" required>
    </div>

    <div class="form-group">
      <label for="artist">Artist *</label>
      <input type="text" id="artist" name="artist" value="{{ song.artist }}" required>
    </div>

    <div class="form-group">
      <label for="tempo_bpm">Tempo (BPM)</label>
      <input type="number" id="tempo_bpm" name="tempo_bpm" value="{{ song.tempo_bpm or '' }}">
    </div>

    <div class="form-group">
      <label for="musical_key">Musical Key</label>
      <input type="text" id="musical_key" name="musical_key" value="{{ song.musical_key or '' }}">
    </div>

    <div class="form-group">
      <label for="genre">Genre</label>
      <input type="text" id="genre" name="genre" value="{{ song.genre or '' }}">
    </div>

    <div class="form-group">
      <label for="tags">Tags (comma-separated)</label>
      <input type="text" id="tags" name="tags" value="{{ song.tags or '' }}">
    </div>

    <div class="form-group">
      <label for="release_year">Release Year</label>
      <input type="number" id="release_year" name="release_year" value="{{ song.release_year or '' }}">
    </div>

    <div class="form-group">
      <label for="duration_override">Duration (mm:ss)</label>
      <input type="text" id="duration_override" name="duration_override" placeholder="3:30" value="{{ fmt_mmss(song.duration_override_sec) if song.duration_override_sec else '' }}">
    </div>

    <div class="form-group">
      <label for="chordChartInput">Chord Chart</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
        <button type="button" id="chordChartConvertBtn" class="btn btn-sm">ðŸŽ¸ Auto-Format Chords</button>
      </div>
      <textarea 
        id="chordChartInput" 
        name="chord_chart" 
        rows="12" 
        style="width: 100%; font-family: monospace; font-size: 0.9rem; border: 1px solid #ccc; padding: 0.5rem; border-radius: 4px;">{{ song.chord_chart or '' }}</textarea>
      <p style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
        Paste raw chords and lyrics. Click "Auto-Format Chords" to format them properly.
        The formatter wraps chords in brackets like [C] and recognizes section headers (Verse, Chorus, Bridge, etc.).
      </p>
    </div>

    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
      <button type="submit" class="btn">Save Song</button>
      <a href="{{ url_for('list_songs') }}" class="btn">Cancel</a>
    </div>
  </form>

  {% if song.files %}
  <div class="section" style="margin-top: 2rem;">
    <h3>Attached PDFs</h3>
    <ul>
      {% for file in song.files %}
      <li>
        {{ file.original_name }}
        {% if song.default_file_id == file.id %}
        <span style="color: green; font-weight: bold;"> (default)</span>
        {% endif %}
        <a href="{{ url_for('view_attachment', att_id=file.id) }}" target="_blank">View</a>
        <form method="post" action="{{ url_for('song_set_default_file', song_id=song.id, file_id=file.id) }}" style="display: inline;">
          <button type="submit" class="btn btn-sm">Set as Default</button>
        </form>
        <form method="post" action="{{ url_for('delete_attachment', att_id=file.id) }}" style="display: inline;">
          <button type="submit" class="btn btn-sm" onclick="return confirm('Delete this file?')">Delete</button>
        </form>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="section" style="margin-top: 2rem;">
    <h3>Upload PDF</h3>
    <form method="post" action="{{ url_for('upload_song_file', song_id=song.id) }}" enctype="multipart/form-data">
      <input type="file" name="file" accept=".pdf" required>
      <button type="submit" class="btn">Upload</button>
    </form>
  </div>
</div>

<!-- Inject the chord chart formatting script -->
<script>
{{ chord_chart_script|safe }}
</script>

<!-- Toast notification helper (if not already defined) -->
<script>
function showToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = 'position: fixed; bottom: 1rem; right: 1rem; background: #333; color: white; padding: 1rem; border-radius: 4px; z-index: 9999; max-width: 400px;';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}
</script>

{% endblock %}
